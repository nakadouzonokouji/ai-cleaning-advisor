<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ローカルサーバーテスト</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #f0f8ff; }
        .test-box { margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        button { margin: 5px; padding: 8px 16px; }
        #results { max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>🧪 ローカルサーバー統合テスト</h1>
    <p>このテストは実際のブラウザ環境で重要機能をテストします</p>
    
    <div class="test-box info">
        <h3>📋 テスト対象機能</h3>
        <ul>
            <li>ESモジュールimport</li>
            <li>クラスインスタンス化</li>
            <li>イベントシステム</li>
            <li>DOM操作</li>
            <li>統合動作</li>
        </ul>
    </div>
    
    <button onclick="runAllTests()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px;">
        🚀 テスト開始
    </button>
    <button onclick="clearResults()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px;">
        🗑️ クリア
    </button>
    
    <div id="results"></div>
    
    <!-- 必要なscript要素（実際のindex.htmlと同様） -->
    <script src="env-config.js"></script>
    
    <script>
        let testResults = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            testResults.push({
                time: timestamp,
                message: message,
                type: type
            });
            updateDisplay();
            console.log(`[${timestamp}] ${message}`);
        }
        
        function updateDisplay() {
            const container = document.getElementById('results');
            container.innerHTML = testResults.map(r => 
                `<div class="test-box ${r.type}">
                    <small>${r.time}</small> ${r.message}
                </div>`
            ).join('');
            container.scrollTop = container.scrollHeight;
        }
        
        function clearResults() {
            testResults = [];
            updateDisplay();
        }
        
        async function runAllTests() {
            clearResults();
            log('🎯 ローカルサーバー統合テスト開始', 'info');
            
            let passedTests = 0;
            let totalTests = 0;
            
            function test(name, condition, errorMsg = '') {
                totalTests++;
                if (condition) {
                    log(`✅ ${name}`, 'success');
                    passedTests++;
                    return true;
                } else {
                    log(`❌ ${name}: ${errorMsg}`, 'error');
                    return false;
                }
            }
            
            try {
                // テスト1: 環境設定確認
                log('📋 テスト1: 環境設定確認', 'info');
                test('window.ENV存在', !!window.ENV, 'ENV設定なし');
                test('window.GEMINI_API_KEY存在', !!window.GEMINI_API_KEY, 'GEMINI_API_KEY設定なし');
                
                // テスト2: ESモジュールimport
                log('📦 テスト2: ESモジュールimport', 'info');
                
                const { COMPREHENSIVE_DIRT_MAPPING } = await import('./js/config/dirt-mapping.js');
                test('DIRT_MAPPING import', !!COMPREHENSIVE_DIRT_MAPPING, 'import失敗');
                test('DIRT_MAPPING データ', Object.keys(COMPREHENSIVE_DIRT_MAPPING).length > 0, 'データなし');
                
                const { COMPREHENSIVE_CLEANING_PRODUCTS } = await import('./js/config/products.js');
                test('CLEANING_PRODUCTS import', !!COMPREHENSIVE_CLEANING_PRODUCTS, 'import失敗');
                test('CLEANING_PRODUCTS データ', Object.keys(COMPREHENSIVE_CLEANING_PRODUCTS).length > 0, 'データなし');
                
                const { APIClient } = await import('./js/modules/api-client.js');
                test('APIClient import', !!APIClient, 'import失敗');
                
                const UIComponents = (await import('./js/modules/ui-components.js')).default;
                test('UIComponents import', !!UIComponents, 'import失敗');
                
                const RealtimeSearchEngine = (await import('./js/modules/search-engine.js')).default;
                test('SearchEngine import', !!RealtimeSearchEngine, 'import失敗');
                
                // テスト3: クラスインスタンス化
                log('🏗️ テスト3: クラスインスタンス化', 'info');
                
                const apiClient = new APIClient();
                test('APIClient インスタンス化', !!apiClient, 'インスタンス化失敗');
                test('enrichProductsWithAmazonData メソッド', typeof apiClient.enrichProductsWithAmazonData === 'function', 'メソッドなし');
                test('getStatus メソッド', typeof apiClient.getStatus === 'function', 'メソッドなし');
                
                const uiComponents = new UIComponents();
                test('UIComponents インスタンス化', !!uiComponents, 'インスタンス化失敗');
                test('EventTarget継承', uiComponents instanceof EventTarget, 'EventTarget継承なし');
                test('on メソッド', typeof uiComponents.on === 'function', 'メソッドなし');
                test('emit メソッド', typeof uiComponents.emit === 'function', 'メソッドなし');
                
                const searchEngine = new RealtimeSearchEngine();
                test('SearchEngine インスタンス化', !!searchEngine, 'インスタンス化失敗');
                test('searchProductsByDirt メソッド', typeof searchEngine.searchProductsByDirt === 'function', 'メソッドなし');
                
                // テスト4: イベントシステム
                log('📡 テスト4: イベントシステム', 'info');
                
                let eventReceived = false;
                let receivedData = null;
                
                uiComponents.on('test-event', (event) => {
                    eventReceived = true;
                    receivedData = event.detail;
                });
                
                uiComponents.emit('test-event', 'テストデータ');
                
                // 少し待ってイベント確認
                await new Promise(resolve => setTimeout(resolve, 50));
                
                test('イベント受信', eventReceived, 'イベント受信失敗');
                test('イベントデータ', receivedData === 'テストデータ', 'データ不一致');
                
                // テスト5: 検索機能
                log('🔍 テスト5: 検索機能', 'info');
                
                const searchResults = await searchEngine.searchProductsByDirt('油汚れ', 'heavy', 'kitchen');
                test('検索実行', Array.isArray(searchResults), '検索失敗');
                test('検索結果', searchResults.length >= 0, '結果なし');
                
                // テスト6: DOM操作
                log('🏗️ テスト6: DOM操作', 'info');
                
                const testDiv = document.createElement('div');
                testDiv.id = 'test-element';
                testDiv.innerHTML = 'テスト要素';
                document.body.appendChild(testDiv);
                
                const foundElement = document.getElementById('test-element');
                test('DOM要素作成', !!foundElement, '要素作成失敗');
                test('innerHTML設定', foundElement.innerHTML === 'テスト要素', 'innerHTML失敗');
                
                // クリーンアップ
                document.body.removeChild(testDiv);
                
                // 最終結果
                log('', 'info');
                const successRate = ((passedTests / totalTests) * 100).toFixed(1);
                
                if (passedTests === totalTests) {
                    log(`🎉🎉🎉 全テスト成功！(${passedTests}/${totalTests})`, 'success');
                    log('💯 ローカル環境での動作確認完了', 'success');
                    log('🚀 本番環境でも完璧に動作します！', 'success');
                } else {
                    log(`⚠️ 一部テスト失敗: ${passedTests}/${totalTests} (${successRate}%)`, 'error');
                }
                
            } catch (error) {
                log(`💥 予期しないエラー: ${error.message}`, 'error');
                console.error('詳細エラー:', error);
            }
        }
        
        // ページ読み込み時に基本チェック
        window.addEventListener('load', () => {
            log('📄 ページ読み込み完了', 'info');
            log('💡 「テスト開始」ボタンをクリックしてください', 'info');
        });
    </script>
</body>
</html>