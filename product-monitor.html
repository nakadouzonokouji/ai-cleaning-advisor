<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ  - AIæƒé™¤ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        .loading { animation: spin 1s linear infinite; }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .monitor-bg { background: linear-gradient(135deg, #1e40af 0%, #3730a3 100%); }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="monitor-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i data-lucide="package-check" class="w-8 h-8 mr-3"></i>
                    <div>
                        <h1 class="text-2xl font-bold">å•†å“ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ </h1>
                        <p class="text-blue-100 text-sm">Amazonå•†å“ã®ãƒªãƒ³ã‚¯åˆ‡ã‚Œãƒ»åœ¨åº«åˆ‡ã‚Œã‚’ç›£è¦–</p>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button id="startMonitorBtn" class="bg-white text-blue-600 px-4 py-2 rounded-lg hover:bg-blue-50 transition-colors font-semibold">
                        <i data-lucide="play" class="w-4 h-4 mr-2 inline"></i>ç›£è¦–é–‹å§‹
                    </button>
                    <button id="exportReportBtn" class="bg-blue-800 text-white px-4 py-2 rounded-lg hover:bg-blue-900 transition-colors">
                        <i data-lucide="download" class="w-4 h-4 mr-2 inline"></i>ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›
                    </button>
                    <a href="admin.html" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                        <i data-lucide="arrow-left" class="w-4 h-4 mr-2 inline"></i>æˆ»ã‚‹
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-6 py-8">
        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-800">ç›£è¦–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
                <div class="flex gap-3">
                    <button id="autoMonitorBtn" class="text-sm bg-blue-100 text-blue-800 px-3 py-1 rounded-full hover:bg-blue-200 transition-colors">
                        <i data-lucide="clock" class="w-3 h-3 mr-1 inline"></i>è‡ªå‹•ç›£è¦–è¨­å®š
                    </button>
                    <button id="refreshBtn" class="text-sm bg-gray-100 text-gray-800 px-3 py-1 rounded-full hover:bg-gray-200 transition-colors">
                        <i data-lucide="refresh-cw" class="w-3 h-3 mr-1 inline"></i>æ›´æ–°
                    </button>
                </div>
            </div>
            <div id="monitorStatus" class="text-gray-600">
                å¾…æ©Ÿä¸­ - ã€Œç›£è¦–é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å•†å“ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’é–‹å§‹ã—ã¦ãã ã•ã„
            </div>
        </div>

        <!-- çµ±è¨ˆæƒ…å ± -->
        <div id="monitorStats" class="mb-8">
            <!-- çµ±è¨ˆæƒ…å ±ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
        </div>

        <!-- ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4">ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Slacké€šçŸ¥</label>
                    <div class="flex items-center">
                        <input type="checkbox" id="slackAlert" class="mr-2">
                        <span class="text-sm text-gray-600">å•é¡Œæ¤œå‡ºæ™‚ã«Slackã«é€šçŸ¥</span>
                    </div>
                    <input type="text" id="slackWebhook" placeholder="Slack Webhook URL" class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ãƒ¡ãƒ¼ãƒ«é€šçŸ¥</label>
                    <div class="flex items-center">
                        <input type="checkbox" id="emailAlert" class="mr-2">
                        <span class="text-sm text-gray-600">å•é¡Œæ¤œå‡ºæ™‚ã«ãƒ¡ãƒ¼ãƒ«é€ä¿¡</span>
                    </div>
                    <input type="email" id="alertEmail" placeholder="é€šçŸ¥å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                </div>
            </div>
        </div>

        <!-- ç›£è¦–çµæœ -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-800">ç›£è¦–çµæœ</h2>
                <div class="text-sm text-gray-600" id="lastCheckTime">
                    <!-- æœ€çµ‚ãƒã‚§ãƒƒã‚¯æ™‚åˆ» -->
                </div>
            </div>
            <div id="monitorResults">
                <div class="text-center text-gray-500 py-8">
                    ç›£è¦–ã‚’é–‹å§‹ã™ã‚‹ã¨çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
                </div>
            </div>
        </div>

        <!-- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="bg-white rounded-xl shadow-lg p-6 mt-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4">ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button id="checkSpecificBtn" class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left">
                    <i data-lucide="search" class="w-5 h-5 text-blue-600 mb-2"></i>
                    <div class="font-medium">ç‰¹å®šå•†å“ãƒã‚§ãƒƒã‚¯</div>
                    <div class="text-sm text-gray-600">ASINã‚’æŒ‡å®šã—ã¦å€‹åˆ¥ãƒã‚§ãƒƒã‚¯</div>
                </button>
                <button id="categoryCheckBtn" class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left">
                    <i data-lucide="layers" class="w-5 h-5 text-green-600 mb-2"></i>
                    <div class="font-medium">ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒã‚§ãƒƒã‚¯</div>
                    <div class="text-sm text-gray-600">ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«å•†å“ã‚’ãƒã‚§ãƒƒã‚¯</div>
                </button>
                <button id="historyBtn" class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left">
                    <i data-lucide="clock" class="w-5 h-5 text-purple-600 mb-2"></i>
                    <div class="font-medium">å±¥æ­´è¡¨ç¤º</div>
                    <div class="text-sm text-gray-600">éå»ã®ç›£è¦–å±¥æ­´ã‚’è¡¨ç¤º</div>
                </button>
            </div>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: ç‰¹å®šå•†å“ãƒã‚§ãƒƒã‚¯ -->
    <div id="specificCheckModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800">ç‰¹å®šå•†å“ãƒã‚§ãƒƒã‚¯</h3>
                    <button class="text-gray-400 hover:text-gray-600" onclick="closeModal('specificCheckModal')">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ASIN</label>
                        <input type="text" id="specificAsin" placeholder="B000FQTJZW" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div class="flex gap-3">
                        <button id="runSpecificCheck" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                            ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
                        </button>
                        <button onclick="closeModal('specificCheckModal')" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: è‡ªå‹•ç›£è¦–è¨­å®š -->
    <div id="autoMonitorModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800">è‡ªå‹•ç›£è¦–è¨­å®š</h3>
                    <button class="text-gray-400 hover:text-gray-600" onclick="closeModal('autoMonitorModal')">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç›£è¦–é–“éš”</label>
                        <select id="monitorInterval" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="1">1æ™‚é–“</option>
                            <option value="6">6æ™‚é–“</option>
                            <option value="12">12æ™‚é–“</option>
                            <option value="24" selected>24æ™‚é–“</option>
                            <option value="168">1é€±é–“</option>
                        </select>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="enableAutoMonitor" class="mr-2">
                        <span class="text-sm text-gray-600">è‡ªå‹•ç›£è¦–ã‚’æœ‰åŠ¹ã«ã™ã‚‹</span>
                    </div>
                    <div class="flex gap-3">
                        <button id="saveAutoMonitor" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                            è¨­å®šä¿å­˜
                        </button>
                        <button onclick="closeModal('autoMonitorModal')" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import ProductMonitor from './js/admin/product-monitor.js';

        // å•†å“ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
        let productMonitor = null;
        
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸ” å•†å“ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹');
            
            try {
                productMonitor = new ProductMonitor();
                setupEventListeners();
                loadSettings();
                updateLastCheckTime();
                
                console.log('âœ… å•†å“ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
            } catch (error) {
                console.error('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            }
            
            // Lucideã‚¢ã‚¤ã‚³ãƒ³åˆæœŸåŒ–
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });

        function setupEventListeners() {
            // ç›£è¦–é–‹å§‹ãƒœã‚¿ãƒ³
            document.getElementById('startMonitorBtn').addEventListener('click', async () => {
                if (productMonitor) {
                    await productMonitor.startProductHealthCheck();
                    updateLastCheckTime();
                }
            });

            // ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›ãƒœã‚¿ãƒ³
            document.getElementById('exportReportBtn').addEventListener('click', () => {
                if (productMonitor) {
                    productMonitor.exportReportCSV();
                }
            });

            // è‡ªå‹•ç›£è¦–è¨­å®šãƒœã‚¿ãƒ³
            document.getElementById('autoMonitorBtn').addEventListener('click', () => {
                document.getElementById('autoMonitorModal').classList.remove('hidden');
            });

            // ç‰¹å®šå•†å“ãƒã‚§ãƒƒã‚¯ãƒœã‚¿ãƒ³
            document.getElementById('checkSpecificBtn').addEventListener('click', () => {
                document.getElementById('specificCheckModal').classList.remove('hidden');
            });

            // ç‰¹å®šå•†å“ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
            document.getElementById('runSpecificCheck').addEventListener('click', async () => {
                const asin = document.getElementById('specificAsin').value.trim();
                if (asin && productMonitor) {
                    closeModal('specificCheckModal');
                    // ç‰¹å®šå•†å“ã®ãƒã‚§ãƒƒã‚¯å®Ÿè£…
                    alert(`${asin}ã®å•†å“ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­... (å®Ÿè£…äºˆå®š)`);
                }
            });

            // è‡ªå‹•ç›£è¦–è¨­å®šä¿å­˜
            document.getElementById('saveAutoMonitor').addEventListener('click', () => {
                const interval = parseInt(document.getElementById('monitorInterval').value);
                const enabled = document.getElementById('enableAutoMonitor').checked;
                
                if (enabled && productMonitor) {
                    productMonitor.startAutoMonitoring(interval);
                } else if (productMonitor) {
                    productMonitor.stopAutoMonitoring();
                }
                
                saveSettings();
                closeModal('autoMonitorModal');
                alert('è‡ªå‹•ç›£è¦–è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            });

            // æ›´æ–°ãƒœã‚¿ãƒ³
            document.getElementById('refreshBtn').addEventListener('click', () => {
                location.reload();
            });
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function saveSettings() {
            const settings = {
                autoMonitor: document.getElementById('enableAutoMonitor').checked,
                monitorInterval: document.getElementById('monitorInterval').value,
                slackAlert: document.getElementById('slackAlert').checked,
                slackWebhook: document.getElementById('slackWebhook').value,
                emailAlert: document.getElementById('emailAlert').checked,
                alertEmail: document.getElementById('alertEmail').value
            };
            
            localStorage.setItem('productMonitorSettings', JSON.stringify(settings));
        }

        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('productMonitorSettings') || '{}');
            
            if (settings.autoMonitor !== undefined) {
                document.getElementById('enableAutoMonitor').checked = settings.autoMonitor;
            }
            if (settings.monitorInterval) {
                document.getElementById('monitorInterval').value = settings.monitorInterval;
            }
            if (settings.slackAlert !== undefined) {
                document.getElementById('slackAlert').checked = settings.slackAlert;
            }
            if (settings.slackWebhook) {
                document.getElementById('slackWebhook').value = settings.slackWebhook;
            }
            if (settings.emailAlert !== undefined) {
                document.getElementById('emailAlert').checked = settings.emailAlert;
            }
            if (settings.alertEmail) {
                document.getElementById('alertEmail').value = settings.alertEmail;
            }
        }

        function updateLastCheckTime() {
            const lastCheckElement = document.getElementById('lastCheckTime');
            if (productMonitor && productMonitor.lastCheck && lastCheckElement) {
                lastCheckElement.textContent = `æœ€çµ‚ãƒã‚§ãƒƒã‚¯: ${productMonitor.lastCheck.toLocaleString('ja-JP')}`;
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
        window.closeModal = closeModal;
    </script>
</body>
</html>