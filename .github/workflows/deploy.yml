name: Deploy to XServer

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
      
    - name: Create deployment files
      run: |
        mkdir upload
        cp index.html upload/
        cp app.js upload/
        cp styles.css upload/
        cp security.js upload/
        
        mkdir upload/server
        cp server/*.js upload/server/
        cp server/*.php upload/server/ || echo "No PHP files to copy"
        
        # Config files
        # ãƒ‡ãƒãƒƒã‚°: ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå±•é–‹ç¢ºèª
        echo "=== ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå±•é–‹ç¢ºèª ==="
        echo "AMAZON_ASSOCIATE_TAG length: ${#AMAZON_ASSOCIATE_TAG}"
        echo "AMAZON_ACCESS_KEY set: ${{ secrets.AMAZON_ACCESS_KEY != '' }}"
        echo "AMAZON_SECRET_KEY set: ${{ secrets.AMAZON_SECRET_KEY != '' }}"
        echo "AMAZON_ASSOCIATE_TAG set: ${{ secrets.AMAZON_ASSOCIATE_TAG != '' }}"
        echo "GEMINI_API_KEY set: ${{ secrets.GEMINI_API_KEY != '' }}"
        
        # Repository Secretså¼·åˆ¶ä½¿ç”¨ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç„¡ã—ï¼‰
        ASSOCIATE_TAG="${{ secrets.AMAZON_ASSOCIATE_TAG }}"
        if [ -z "$ASSOCIATE_TAG" ]; then
          echo "âŒ ERROR: AMAZON_ASSOCIATE_TAG not set in Repository Secrets"
          echo "Repository Secretsã§ã‚¢ã‚½ã‚·ã‚¨ã‚¤ãƒ„ã‚¿ã‚°ã‚’è¨­å®šã—ã¦ãã ã•ã„"
          exit 1
        else
          echo "âœ… Repository Secretsä½¿ç”¨: ${ASSOCIATE_TAG:0:8}..."
        fi
        
        cat > upload/env-config.js << EOF
        window.ENV = {
          API_ENDPOINT: '/tools/ai-cleaner/server/amazon-proxy.php',
          VERSION: '3.1.0',
          AMAZON_ASSOCIATE_TAG: '$ASSOCIATE_TAG'
        };
        console.log('ğŸ” æœ¬ç•ªç’°å¢ƒè¨­å®šèª­ã¿è¾¼ã¿å®Œäº†');
        console.log('ğŸ›’ Repository Secretsé©ç”¨æ¸ˆã¿ - Associate Tag:', window.ENV.AMAZON_ASSOCIATE_TAG);
        EOF
        
        # Repository Secretsæ¤œè¨¼
        if [ -z "${{ secrets.AMAZON_ACCESS_KEY }}" ]; then
          echo "âŒ ERROR: AMAZON_ACCESS_KEY not set in Repository Secrets"
          exit 1
        fi
        if [ -z "${{ secrets.AMAZON_SECRET_KEY }}" ]; then
          echo "âŒ ERROR: AMAZON_SECRET_KEY not set in Repository Secrets"
          exit 1
        fi
        if [ -z "${{ secrets.GEMINI_API_KEY }}" ]; then
          echo "âŒ ERROR: GEMINI_API_KEY not set in Repository Secrets"
          exit 1
        fi
        
        cat > upload/server/config.php << 'EOF'
        <?php
        define('AMAZON_ACCESS_KEY', '${{ secrets.AMAZON_ACCESS_KEY }}');
        define('AMAZON_SECRET_KEY', '${{ secrets.AMAZON_SECRET_KEY }}');
        define('AMAZON_ASSOCIATE_TAG', '${{ secrets.AMAZON_ASSOCIATE_TAG }}');
        define('GEMINI_API_KEY', '${{ secrets.GEMINI_API_KEY }}');
        ?>
        EOF
        
        echo "Files prepared:"
        ls -la upload/
        ls -la upload/server/
        
        echo "=== ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ç¢ºèª ==="
        echo "app.js first 10 lines:"
        head -10 upload/app.js
        echo "env-config.js content:"
        cat upload/env-config.js
        
    - name: Deploy via FTP
      uses: SamKirkland/FTP-Deploy-Action@4.3.3
      with:
        server: ${{ secrets.XSERVER_FTP_HOST }}
        username: ${{ secrets.XSERVER_FTP_USER }}
        password: ${{ secrets.XSERVER_FTP_PASS }}
        local-dir: "upload/"
        server-dir: "/cxmainte.com/public_html/tools/ai-cleaner/"
        dry-run: false
        log-level: verbose
        
    - name: Post-deployment verification
      run: |
        echo "=== ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ç¢ºèª ==="
        echo "ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆ: /cxmainte.com/public_html/tools/ai-cleaner/"
        echo "ç¢ºèªURL: https://cxmainte.com/tools/ai-cleaner/"
        echo "ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼: https://webftp-sv6095.xserver.jp/cxmainte.com/public_html/tools/ai-cleaner"
        date