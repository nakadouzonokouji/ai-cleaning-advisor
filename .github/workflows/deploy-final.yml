name: Deploy to XServer (Final)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup Git
      run: |
        git config --global init.defaultBranch main
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"
        
    - name: Checkout Code and Create Deploy Directory
      run: |
        # 新しいディレクトリを作成してクリーンな環境を構築
        mkdir -p deploy-temp
        cd deploy-temp
        git clone https://github.com/nakadouzonokouji/ai-cleaner.git .
        
        # 必要なファイルのみを親ディレクトリにコピー
        cd ..
        mkdir -p deploy
        
        # 必要なファイルをコピー（.gitは含まない）
        cp deploy-temp/index.html deploy/
        cp deploy-temp/app.js deploy/
        cp deploy-temp/styles.css deploy/
        cp deploy-temp/amazon-config.js deploy/
        cp -r deploy-temp/server deploy/
        
        # 作業ディレクトリを変更
        cd deploy
        ls -la
        
    - name: Create Config Files
      run: |
        cd deploy
        echo "Creating server config..."
        mkdir -p server
        
        cat > server/config.php << 'EOF'
        <?php
        define('AMAZON_ACCESS_KEY', '${{ secrets.AMAZON_ACCESS_KEY }}');
        define('AMAZON_SECRET_KEY', '${{ secrets.AMAZON_SECRET_KEY }}');
        define('AMAZON_ASSOCIATE_TAG', '${{ secrets.AMAZON_ASSOCIATE_TAG }}');
        define('GEMINI_API_KEY', '${{ secrets.GEMINI_API_KEY }}');
        ?>
        EOF
        
        cat > env-config.js << 'EOF'
        window.ENV = {
          API_ENDPOINT: '/tools/ai-cleaner/server/amazon-proxy.php',
          VERSION: '3.1.0'
        };
        console.log('🔐 本番環境設定読み込み完了');
        EOF
        
        echo "✅ Config files created"
        ls -la
        
    - name: Deploy via LFTP
      run: |
        cd deploy
        
        # LFTPをインストール
        sudo apt-get update
        sudo apt-get install -y lftp
        
        # FTP接続とファイル転送
        lftp -c "
        set ftp:ssl-allow no;
        open ftp://${{ secrets.XSERVER_FTP_USER }}:${{ secrets.XSERVER_FTP_PASS }}@${{ secrets.XSERVER_FTP_HOST }};
        lcd .;
        cd /public_html/tools/ai-cleaner/;
        mirror --reverse --delete --verbose ./ ./;
        quit;
        "
        
        echo "✅ LFTP deployment completed"
          
    - name: Success Notification
      run: |
        echo "🎉 デプロイ完了!"
        echo "🌐 URL: https://cxmainte.com/tools/ai-cleaner/"
        echo "⏰ 時刻: $(date '+%Y-%m-%d %H:%M:%S')"