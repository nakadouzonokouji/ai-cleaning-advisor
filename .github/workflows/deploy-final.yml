name: Deploy to XServer (Final)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup Git
      run: |
        git config --global init.defaultBranch main
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"
        
    - name: Checkout Code and Create Deploy Directory
      run: |
        # æ–°ã—ã„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¦ã‚¯ãƒªãƒ¼ãƒ³ãªç’°å¢ƒã‚’æ§‹ç¯‰
        mkdir -p deploy-temp
        cd deploy-temp
        git clone https://github.com/nakadouzonokouji/ai-cleaner.git .
        
        # å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼
        cd ..
        mkdir -p deploy
        
        # å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆ.gitã¯å«ã¾ãªã„ï¼‰
        cp deploy-temp/index.html deploy/
        cp deploy-temp/app.js deploy/
        cp deploy-temp/styles.css deploy/
        cp deploy-temp/amazon-config.js deploy/
        cp -r deploy-temp/server deploy/
        
        # ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å¤‰æ›´
        cd deploy
        ls -la
        
    - name: Create Config Files
      run: |
        cd deploy
        echo "Creating server config..."
        mkdir -p server
        
        cat > server/config.php << 'EOF'
        <?php
        define('AMAZON_ACCESS_KEY', '${{ secrets.AMAZON_ACCESS_KEY }}');
        define('AMAZON_SECRET_KEY', '${{ secrets.AMAZON_SECRET_KEY }}');
        define('AMAZON_ASSOCIATE_TAG', '${{ secrets.AMAZON_ASSOCIATE_TAG }}');
        define('GEMINI_API_KEY', '${{ secrets.GEMINI_API_KEY }}');
        ?>
        EOF
        
        cat > env-config.js << 'EOF'
        window.ENV = {
          API_ENDPOINT: '/tools/ai-cleaner/server/amazon-proxy.php',
          VERSION: '3.1.0'
        };
        console.log('ðŸ” æœ¬ç•ªç’°å¢ƒè¨­å®šèª­ã¿è¾¼ã¿å®Œäº†');
        EOF
        
        echo "âœ… Config files created"
        ls -la
        
    - name: Deploy via FTP
      uses: SamKirkland/FTP-Deploy-Action@4.3.3
      with:
        server: ${{ secrets.XSERVER_FTP_HOST }}
        username: ${{ secrets.XSERVER_FTP_USER }}
        password: ${{ secrets.XSERVER_FTP_PASS }}
        local-dir: "deploy/"
        server-dir: "/public_html/tools/ai-cleaner/"
          
    - name: Success Notification
      run: |
        echo "ðŸŽ‰ ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†!"
        echo "ðŸŒ URL: https://cxmainte.com/tools/ai-cleaner/"
        echo "â° æ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S')"