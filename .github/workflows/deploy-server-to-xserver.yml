name: Deploy Server to XSERVER

on:
  push:
    branches: [ main ]
    paths:
      - 'server/**'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œå¯èƒ½

jobs:
  deploy-server:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¦ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: server/package-lock.json
        
    - name: ğŸ“¥ Install dependencies  
      run: |
        cd server
        npm ci --only=production
        
    - name: ğŸš€ Deploy Server to XSERVER
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.XSERVER_FTP_HOST }}
        username: ${{ secrets.XSERVER_FTP_USER }}
        password: ${{ secrets.XSERVER_FTP_PASS }}
        local-dir: ./server/
        server-dir: /public_html/ai-cleaner-server/
        exclude: |
          .env.example
          README.md
          *.log
          
    - name: ğŸ“ Create environment file
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.XSERVER_FTP_HOST }}
        username: ${{ secrets.XSERVER_FTP_USER }}
        password: ${{ secrets.XSERVER_FTP_PASS }}
        local-dir: ./
        server-dir: /public_html/ai-cleaner-server/
        exclude: |
          **/*
        include: |
          .env.production
          
    - name: âœ… Server Deployment Status
      run: |
        echo "ğŸš€ AIæƒé™¤ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã‚µãƒ¼ãƒãƒ¼ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
        echo "ğŸ”§ Node.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³: ai-cleaner-server/"
        echo "ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚åˆ»: $(date)"
        echo "âš ï¸ ã‚µãƒ¼ãƒãƒ¼èµ·å‹•: pm2ã‚„foreverã§èµ·å‹•ã—ã¦ãã ã•ã„"