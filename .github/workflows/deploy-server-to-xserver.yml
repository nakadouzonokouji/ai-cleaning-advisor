name: Deploy Server to XSERVER

on:
  push:
    branches: [ main ]
    paths:
      - 'server/**'
  workflow_dispatch: # 手動実行可能

jobs:
  deploy-server:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📦 Checkout repository
      uses: actions/checkout@v4
      
    - name: 🔧 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: server/package-lock.json
        
    - name: 📥 Install dependencies  
      run: |
        cd server
        npm ci --only=production
        
    - name: 🚀 Deploy Server to XSERVER
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.XSERVER_FTP_HOST }}
        username: ${{ secrets.XSERVER_FTP_USER }}
        password: ${{ secrets.XSERVER_FTP_PASS }}
        local-dir: ./server/
        server-dir: /public_html/ai-cleaner-server/
        exclude: |
          .env.example
          README.md
          *.log
          
    - name: 📝 Create environment file
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.XSERVER_FTP_HOST }}
        username: ${{ secrets.XSERVER_FTP_USER }}
        password: ${{ secrets.XSERVER_FTP_PASS }}
        local-dir: ./
        server-dir: /public_html/ai-cleaner-server/
        exclude: |
          **/*
        include: |
          .env.production
          
    - name: ✅ Server Deployment Status
      run: |
        echo "🚀 AI掃除アドバイザーサーバーのデプロイが完了しました！"
        echo "🔧 Node.jsアプリケーション: ai-cleaner-server/"
        echo "📊 デプロイ時刻: $(date)"
        echo "⚠️ サーバー起動: pm2やforeverで起動してください"